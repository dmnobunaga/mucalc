<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ö–∞–º–Ω–µ–π - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            display: inline-block;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .calculator-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .calculator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stone-type-select {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            font-weight: 600;
        }

        .stone-type-select option {
            background: white;
            color: #333;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .results-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-top: 30px;
            display: none;
        }

        .results-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        .result-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .stones-breakdown {
            margin-top: 20px;
        }

        .stones-breakdown h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .stone-level {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .bonus-section {
            background: rgba(255,255,255,0.25);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .bonus-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .bonus-item {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .optimization-section {
            background: rgba(255,255,255,0.25);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .slot-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .error-message {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.1rem;
        }

        .stone-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .stone-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .fire { background: linear-gradient(45deg, #ff6b6b, #ff8e53); }
        .water { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .ice { background: linear-gradient(45deg, #a8edea, #fed6e3); color: #333; }
        .wind { background: linear-gradient(45deg, #ffecd2, #fcb69f); color: #333; }

        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .result-summary {
                grid-template-columns: 1fr;
            }

            .slot-config {
                grid-template-columns: 1fr;
            }
        }

        .animation-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ö–∞–º–Ω–µ–π</h1>
            <p>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤–∞—à–∏—Ö –∫–∞–º–Ω–µ–π —Å —É—á–µ—Ç–æ–º –±–æ–Ω—É—Å–æ–≤</p>
            <div class="version-badge">‚ú® –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Å –±–æ–Ω—É—Å–∞–º–∏ –∏ —Å–ª–æ—Ç–∞–º–∏</div>
            
            <div class="stone-icons">
                <div class="stone-icon fire">üî•</div>
                <div class="stone-icon water">üíß</div>
                <div class="stone-icon ice">‚ùÑÔ∏è</div>
                <div class="stone-icon wind">üí®</div>
            </div>
        </div>

        <div class="calculator-grid">
            <!-- –†–∞—Å—á–µ—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–∞–º–Ω–µ–π -->
            <div class="calculator-card">
                <h2 class="card-title">üìä –†–∞—Å—á–µ—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–∞–º–Ω–µ–π</h2>
                <form id="stones-form">
                    <div class="form-group">
                        <label for="stone-type-1">–¢–∏–ø –∫–∞–º–Ω—è:</label>
                        <select id="stone-type-1" class="stone-type-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–∞–º–Ω—è</option>
                            <option value="Fire">üî• Fire (–ê—Ç–∞–∫–∞)</option>
                            <option value="Water">üíß Water (–ó–¥–æ—Ä–æ–≤—å–µ)</option>
                            <option value="Ice">‚ùÑÔ∏è Ice (–ê—Ç–∞–∫–∞)</option>
                            <option value="Wind">üí® Wind (–ó–∞—â–∏—Ç–∞)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="base-stones">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–∑–æ–≤—ã—Ö –∫–∞–º–Ω–µ–π (1 —É—Ä–æ–≤–µ–Ω—å):</label>
                        <input type="number" id="base-stones" min="0" step="1" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="price-per-stone-1">–¶–µ–Ω–∞ –∑–∞ –∫–∞–º–µ–Ω—å:</label>
                        <input type="number" id="price-per-stone-1" min="0" step="0.01" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É" required>
                    </div>

                    <div class="slot-config">
                        <div class="form-group">
                            <label for="equipment-slots-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:</label>
                            <input type="number" id="equipment-slots-1" min="1" max="7" value="6" placeholder="6-7">
                        </div>
                        <div class="form-group">
                            <label for="stones-per-item-1">–ö–∞–º–Ω–µ–π –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:</label>
                            <input type="number" id="stones-per-item-1" min="1" max="3" value="3" placeholder="1-3">
                        </div>
                    </div>
                    
                    <button type="submit" class="calculate-btn">üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                </form>
            </div>

            <!-- –†–∞—Å—á–µ—Ç –ø–æ –±—é–¥–∂–µ—Ç—É -->
            <div class="calculator-card">
                <h2 class="card-title">üí∞ –†–∞—Å—á–µ—Ç –ø–æ –±—é–¥–∂–µ—Ç—É</h2>
                <form id="budget-form">
                    <div class="form-group">
                        <label for="stone-type-2">–¢–∏–ø –∫–∞–º–Ω—è:</label>
                        <select id="stone-type-2" class="stone-type-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–∞–º–Ω—è</option>
                            <option value="Fire">üî• Fire (–ê—Ç–∞–∫–∞)</option>
                            <option value="Water">üíß Water (–ó–¥–æ—Ä–æ–≤—å–µ)</option>
                            <option value="Ice">‚ùÑÔ∏è Ice (–ê—Ç–∞–∫–∞)</option>
                            <option value="Wind">üí® Wind (–ó–∞—â–∏—Ç–∞)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="budget">–î–æ—Å—Ç—É–ø–Ω—ã–π –±—é–¥–∂–µ—Ç:</label>
                        <input type="number" id="budget" min="0" step="0.01" placeholder="–í–≤–µ–¥–∏—Ç–µ –±—é–¥–∂–µ—Ç" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="price-per-stone-2">–¶–µ–Ω–∞ –∑–∞ –∫–∞–º–µ–Ω—å:</label>
                        <input type="number" id="price-per-stone-2" min="0" step="0.01" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É" required>
                    </div>

                    <div class="slot-config">
                        <div class="form-group">
                            <label for="equipment-slots-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:</label>
                            <input type="number" id="equipment-slots-2" min="1" max="7" value="6" placeholder="6-7">
                        </div>
                        <div class="form-group">
                            <label for="stones-per-item-2">–ö–∞–º–Ω–µ–π –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:</label>
                            <input type="number" id="stones-per-item-2" min="1" max="3" value="3" placeholder="1-3">
                        </div>
                    </div>
                    
                    <button type="submit" class="calculate-btn">üíé –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                </form>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="results" class="results-section">
            <h2 class="results-title">üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞</h2>
            <div id="results-content"></div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –∫–∞–º–Ω–µ–π
        const STONE_TYPES = {
            'Fire': { base_stat: 'attack', base_value: 0, increment: 1 },
            'Water': { base_stat: 'health', base_value: 38, increment: 28 },
            'Ice': { base_stat: 'attack', base_value: 0, increment: 1 },
            'Wind': { base_stat: 'defense', base_value: 1, increment: 1 }
        };

        // –ë–æ–Ω—É—Å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        const BONUS_TABLE = {
            'Water': [
                { level: 21, value: 12, bonus: '30% restore HP' },
                { level: 42, value: 21, bonus: '5%' },
                { level: 63, value: 31, bonus: '7.50%' },
                { level: 84, value: 44, bonus: '12.50%' },
                { level: 105, value: 52, bonus: '15%' },
                { level: 126, value: 83, bonus: '17.50%' },
                { level: 147, value: 143, bonus: '20%' },
                { level: 168, value: 261, bonus: '20%' },
                { level: 189, value: 495, bonus: '20%' },
                { level: 210, value: 952, bonus: '20%' },
                { level: 231, value: 1840, bonus: '20%' },
                { level: 252, value: 3543, bonus: '20%' }
            ],
            'Ice': [
                { level: 21, value: 0, bonus: '% ATK bonus' },
                { level: 42, value: 0, bonus: '10%' },
                { level: 63, value: 0, bonus: '10%' },
                { level: 84, value: 0, bonus: '10%' },
                { level: 105, value: 0, bonus: '10%' },
                { level: 126, value: 0, bonus: '10%' },
                { level: 147, value: 0, bonus: '10%' },
                { level: 168, value: 0, bonus: '10%' },
                { level: 189, value: 0, bonus: '10%' },
                { level: 210, value: 0, bonus: '10%' },
                { level: 231, value: 0, bonus: '10%' },
                { level: 252, value: 0, bonus: '10%' }
            ],
            'Wind': [
                { level: 21, value: 0, bonus: 'PVP DMG Red' },
                { level: 42, value: 4.18, bonus: '4.18%' },
                { level: 63, value: 4.92, bonus: '4.92%' },
                { level: 84, value: 5.79, bonus: '5.79%' },
                { level: 105, value: 6.81, bonus: '6.81%' },
                { level: 126, value: 8.01, bonus: '8.01%' },
                { level: 147, value: 9.43, bonus: '9.43%' },
                { level: 168, value: 11.09, bonus: '11.09%' },
                { level: 189, value: 13.05, bonus: '13.05%' },
                { level: 210, value: 15.35, bonus: '15.35%' },
                { level: 231, value: 18.06, bonus: '18.06%' },
                { level: 252, value: 21.25, bonus: '21.25%' }
            ],
            'Fire': [
                { level: 21, value: 0, bonus: '30% extra DMG' },
                { level: 42, value: 4, bonus: '4' },
                { level: 63, value: 6, bonus: '6' },
                { level: 84, value: 8, bonus: '8' },
                { level: 105, value: 10, bonus: '10' },
                { level: 126, value: 16, bonus: '16' },
                { level: 147, value: 48, bonus: '48' },
                { level: 168, value: 51, bonus: '51' },
                { level: 189, value: 90, bonus: '90' },
                { level: 210, value: 150, bonus: '150' },
                { level: 231, value: 368, bonus: '368' },
                { level: 252, value: 708, bonus: '708' }
            ]
        };

        // –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–∞–º–Ω–µ–π —Å –±–æ–Ω—É—Å–∞–º–∏
        class EnhancedStoneCalculator {
            static calculateStonesFromBase(stoneType, baseStones, pricePerStone, equipmentSlots, stonesPerItem) {
                if (!STONE_TYPES[stoneType]) {
                    return null;
                }

                const maxSlots = equipmentSlots * stonesPerItem;
                const stonesByLevel = { 1: baseStones };
                let currentLevel = 1;

                // –°–∏–Ω—Ç–µ–∑ –∫–∞–º–Ω–µ–π –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
                while (stonesByLevel[currentLevel] >= 2) {
                    const nextLevel = currentLevel + 1;
                    const stonesNextLevel = Math.floor(stonesByLevel[currentLevel] / 2);

                    if (stonesNextLevel > 0) {
                        stonesByLevel[nextLevel] = stonesNextLevel;
                        stonesByLevel[currentLevel] = stonesByLevel[currentLevel] % 2;
                    }

                    currentLevel++;
                }

                // –†–∞—Å—á–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è
                const statsByLevel = {};
                const stoneConfig = STONE_TYPES[stoneType];

                for (const [level, count] of Object.entries(stonesByLevel)) {
                    if (count > 0) {
                        const statValue = stoneConfig.base_value + (parseInt(level) - 1) * stoneConfig.increment;
                        statsByLevel[level] = {
                            count: count,
                            stat_type: stoneConfig.base_stat,
                            stat_value: statValue,
                            total_stat: statValue * count
                        };
                    }
                }

                // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–º–Ω–µ–π –ø–æ —Å–ª–æ—Ç–∞–º
                const optimization = this.optimizeStoneDistribution(stonesByLevel, stoneType, maxSlots);

                const totalCost = baseStones * pricePerStone;
                const maxLevel = Math.max(...Object.keys(stonesByLevel).map(Number));

                return {
                    stone_type: stoneType,
                    base_stones: baseStones,
                    price_per_stone: pricePerStone,
                    total_cost: totalCost,
                    max_level: maxLevel,
                    stones_by_level: stonesByLevel,
                    stats_by_level: statsByLevel,
                    optimization: optimization,
                    equipment_slots: equipmentSlots,
                    stones_per_item: stonesPerItem,
                    max_slots: maxSlots
                };
            }

            static calculateStonesFromBudget(stoneType, budget, pricePerStone, equipmentSlots, stonesPerItem) {
                if (!STONE_TYPES[stoneType]) {
                    return null;
                }

                const baseStones = Math.floor(budget / pricePerStone);

                if (baseStones === 0) {
                    return {
                        stone_type: stoneType,
                        budget: budget,
                        price_per_stone: pricePerStone,
                        base_stones: 0,
                        max_level: 0,
                        stones_by_level: {},
                        stats_by_level: {},
                        optimization: { configurations: [], best_bonus: null },
                        equipment_slots: equipmentSlots,
                        stones_per_item: stonesPerItem,
                        max_slots: equipmentSlots * stonesPerItem
                    };
                }

                return this.calculateStonesFromBase(stoneType, baseStones, pricePerStone, equipmentSlots, stonesPerItem);
            }

            static optimizeStoneDistribution(stonesByLevel, stoneType, maxSlots) {
                const configurations = [];
                const bonusTable = BONUS_TABLE[stoneType] || [];

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–º–Ω–µ–π
                const stones = [];
                for (const [level, count] of Object.entries(stonesByLevel)) {
                    for (let i = 0; i < count; i++) {
                        stones.push(parseInt(level));
                    }
                }

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–º–Ω–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é —É—Ä–æ–≤–Ω—è –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –≤—ã—Å–æ–∫–∏—Ö —É—Ä–æ–≤–Ω–µ–π
                stones.sort((a, b) => b - a);

                if (stones.length === 0) {
                    return { configurations: [], best_bonus: null };
                }

                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 1: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∫–∞–º–Ω–∏ –≤ —Å–ª–æ—Ç–∞—Ö
                const config1 = stones.slice(0, maxSlots);
                const totalLevel1 = config1.reduce((sum, level) => sum + level, 0);
                const bonus1 = this.getBonusForLevel(totalLevel1, bonusTable);

                configurations.push({
                    name: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∫–∞–º–Ω–∏ –≤ —Å–ª–æ—Ç–∞—Ö',
                    stones: config1,
                    total_level: totalLevel1,
                    bonus: bonus1,
                    unused_stones: stones.slice(maxSlots)
                });

                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ –±–æ–Ω—É—Å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏
                let bestConfig = config1;
                let bestBonus = bonus1;

                for (const bonusThreshold of bonusTable) {
                    const config = this.findOptimalConfigForThreshold(stones, bonusThreshold.level, maxSlots);
                    if (config && config.total_level >= bonusThreshold.level) {
                        const bonus = this.getBonusForLevel(config.total_level, bonusTable);
                        configurations.push({
                            name: `–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ LVL ${bonusThreshold.level}`,
                            stones: config.stones,
                            total_level: config.total_level,
                            bonus: bonus,
                            unused_stones: config.unused_stones
                        });

                        if (bonus && (!bestBonus || this.compareBonuses(bonus, bestBonus) > 0)) {
                            bestConfig = config.stones;
                            bestBonus = bonus;
                        }
                    }
                }

                return {
                    configurations: configurations,
                    best_bonus: bestBonus
                };
            }

            static findOptimalConfigForThreshold(stones, targetLevel, maxSlots) {
                // –ü—Ä–æ—Å—Ç–∞—è –∂–∞–¥–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: –±–µ—Ä–µ–º –∫–∞–º–Ω–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω–µ–º —Ü–µ–ª–µ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è
                const config = [];
                let currentLevel = 0;
                const remaining = [...stones];

                for (let i = 0; i < remaining.length && config.length < maxSlots; i++) {
                    if (currentLevel + remaining[i] <= targetLevel + 10) { // –Ω–µ–±–æ–ª—å—à–æ–π –±—É—Ñ–µ—Ä
                        config.push(remaining[i]);
                        currentLevel += remaining[i];
                        remaining.splice(i, 1);
                        i--;
                    }
                }

                return {
                    stones: config,
                    total_level: currentLevel,
                    unused_stones: remaining
                };
            }

            static getBonusForLevel(totalLevel, bonusTable) {
                let bestBonus = null;
                for (const bonus of bonusTable) {
                    if (totalLevel >= bonus.level) {
                        bestBonus = bonus;
                    } else {
                        break;
                    }
                }
                return bestBonus;
            }

            static compareBonuses(bonus1, bonus2) {
                if (!bonus1 && !bonus2) return 0;
                if (!bonus1) return -1;
                if (!bonus2) return 1;
                return bonus1.level - bonus2.level;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–∞—Å—á–µ—Ç–∞ –ø–æ –∫–∞–º–Ω—è–º
            document.getElementById('stones-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const stoneType = document.getElementById('stone-type-1').value;
                const baseStones = parseInt(document.getElementById('base-stones').value);
                const pricePerStone = parseFloat(document.getElementById('price-per-stone-1').value);
                const equipmentSlots = parseInt(document.getElementById('equipment-slots-1').value) || 6;
                const stonesPerItem = parseInt(document.getElementById('stones-per-item-1').value) || 3;
                
                if (!stoneType || isNaN(baseStones) || isNaN(pricePerStone)) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                    return;
                }

                if (baseStones < 0 || pricePerStone < 0) {
                    showError('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–º–Ω–µ–π –∏ —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏');
                    return;
                }
                
                calculateFromStones(stoneType, baseStones, pricePerStone, equipmentSlots, stonesPerItem);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–∞—Å—á–µ—Ç–∞ –ø–æ –±—é–¥–∂–µ—Ç—É
            document.getElementById('budget-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const stoneType = document.getElementById('stone-type-2').value;
                const budget = parseFloat(document.getElementById('budget').value);
                const pricePerStone = parseFloat(document.getElementById('price-per-stone-2').value);
                const equipmentSlots = parseInt(document.getElementById('equipment-slots-2').value) || 6;
                const stonesPerItem = parseInt(document.getElementById('stones-per-item-2').value) || 3;
                
                if (!stoneType || isNaN(budget) || isNaN(pricePerStone)) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                    return;
                }

                if (budget < 0 || pricePerStone <= 0) {
                    showError('–ë—é–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º, —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è');
                    return;
                }
                
                calculateFromBudget(stoneType, budget, pricePerStone, equipmentSlots, stonesPerItem);
            });
        });

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–∞–º–Ω–µ–π
        function calculateFromStones(stoneType, baseStones, pricePerStone, equipmentSlots, stonesPerItem) {
            showLoading();
            
            try {
                const result = EnhancedStoneCalculator.calculateStonesFromBase(stoneType, baseStones, pricePerStone, equipmentSlots, stonesPerItem);
                
                if (result === null) {
                    showError(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫–∞–º–Ω—è: ${stoneType}`);
                    return;
                }
                
                displayResults(result, 'stones');
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ä–∞—Å—á–µ—Ç–∞: ' + error.message);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ø–æ –±—é–¥–∂–µ—Ç—É
        function calculateFromBudget(stoneType, budget, pricePerStone, equipmentSlots, stonesPerItem) {
            showLoading();
            
            try {
                const result = EnhancedStoneCalculator.calculateStonesFromBudget(stoneType, budget, pricePerStone, equipmentSlots, stonesPerItem);
                
                if (result === null) {
                    showError(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫–∞–º–Ω—è: ${stoneType}`);
                    return;
                }
                
                displayResults(result, 'budget');
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ä–∞—Å—á–µ—Ç–∞: ' + error.message);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults(result, calculationType) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            const stoneEmoji = {
                'Fire': 'üî•',
                'Water': 'üíß',
                'Ice': '‚ùÑÔ∏è',
                'Wind': 'üí®'
            };
            
            const statNames = {
                'attack': '–ê—Ç–∞–∫–∞',
                'health': '–ó–¥–æ—Ä–æ–≤—å–µ',
                'defense': '–ó–∞—â–∏—Ç–∞'
            };
            
            let html = `
                <div class="result-card animation-fade-in">
                    <h3>${stoneEmoji[result.stone_type]} ${result.stone_type}</h3>
                    
                    <div class="result-summary">
                        <div class="summary-item">
                            <div class="label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</div>
                            <div class="value">${result.max_level}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                            <div class="value">${result.total_cost || result.budget || 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">–ë–∞–∑–æ–≤—ã—Ö –∫–∞–º–Ω–µ–π</div>
                            <div class="value">${result.base_stones}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">–î–æ—Å—Ç—É–ø–Ω–æ —Å–ª–æ—Ç–æ–≤</div>
                            <div class="value">${result.max_slots}</div>
                        </div>
                    </div>
            `;
            
            if (Object.keys(result.stats_by_level).length > 0) {
                html += `
                    <div class="stones-breakdown">
                        <h4>üìã –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–º–Ω–µ–π –ø–æ —É—Ä–æ–≤–Ω—è–º:</h4>
                `;
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —É—Ä–æ–≤–Ω–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
                const sortedLevels = Object.keys(result.stats_by_level).sort((a, b) => parseInt(a) - parseInt(b));
                
                for (const level of sortedLevels) {
                    const stats = result.stats_by_level[level];
                    html += `
                        <div class="stone-level">
                            <div><strong>–£—Ä–æ–≤–µ–Ω—å ${level}:</strong> ${stats.count} –∫–∞–º–Ω–µ–π</div>
                            <div><strong>${statNames[stats.stat_type]}:</strong> ${stats.stat_value} –∑–∞ –∫–∞–º–µ–Ω—å</div>
                            <div><strong>–û–±—â–∏–π ${statNames[stats.stat_type]}:</strong> ${stats.total_stat}</div>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                // –ü–æ–¥—Å—á–µ—Ç –æ–±—â–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
                let totalStats = 0;
                let statType = '';
                for (const level in result.stats_by_level) {
                    totalStats += result.stats_by_level[level].total_stat;
                    statType = result.stats_by_level[level].stat_type;
                }
                
                html += `
                    <div class="summary-item" style="margin-top: 20px; background: rgba(255,255,255,0.3);">
                        <div class="label">–ò—Ç–æ–≥–æ ${statNames[statType]}</div>
                        <div class="value" style="font-size: 1.5rem;">${totalStats}</div>
                    </div>
                `;

                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
                if (result.optimization && result.optimization.configurations.length > 0) {
                    html += `
                        <div class="optimization-section">
                            <div class="bonus-title">üéØ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–º–Ω–µ–π</div>
                    `;

                    for (const config of result.optimization.configurations) {
                        html += `
                            <div class="bonus-item">
                                <div>
                                    <strong>${config.name}</strong><br>
                                    –ö–∞–º–Ω–∏ –≤ —Å–ª–æ—Ç–∞—Ö: [${config.stones.join(', ')}]<br>
                                    –°—É–º–º–∞—Ä–Ω—ã–π LVL: ${config.total_level}
                                </div>
                                <div>
                                    ${config.bonus ? `<strong>–ë–æ–Ω—É—Å LVL ${config.bonus.level}:</strong><br>${config.bonus.bonus}` : '–ù–µ—Ç –±–æ–Ω—É—Å–∞'}
                                </div>
                            </div>
                        `;
                    }

                    html += `</div>`;
                }

                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤
                const bonusTable = BONUS_TABLE[result.stone_type];
                if (bonusTable && bonusTable.length > 0) {
                    html += `
                        <div class="bonus-section">
                            <div class="bonus-title">üéÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ –±–æ–Ω—É—Å—ã</div>
                    `;

                    for (const bonus of bonusTable.slice(0, 6)) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 6 –±–æ–Ω—É—Å–æ–≤
                        html += `
                            <div class="bonus-item">
                                <div><strong>LVL ${bonus.level}</strong></div>
                                <div>${bonus.bonus}${bonus.value > 0 ? ` (+${bonus.value})` : ''}</div>
                            </div>
                        `;
                    }

                    html += `</div>`;
                }
            } else {
                html += `<p style="text-align: center; margin-top: 20px;">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∫–∞–º–Ω–µ–π.</p>`;
            }
            
            html += `</div>`;
            
            resultsContent.innerHTML = html;
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '<div class="loading">‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç...</div>';
            resultsDiv.style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = `<div class="error-message animation-fade-in">‚ùå ${message}</div>`;
            resultsDiv.style.display = 'block';
        }
    </script>
</body>
</html>

